# Rate Limit Fallback Plugin - Architecture

## 1. 機能要件（Functional Requirements）

### 1.1 コア機能
- **レート制限検知**: 複数のイベントソース（session.error, message.updated, session.status）からレート制限エラーを検知
- **自動フォールバック**: レート制限検知時に自動的にフォールバックモデルに切り替え
- **セッション管理**: 現在のセッションをアボートし、最後のユーザーメッセージを新しいモデルで再送信
- **モデル追跡**: フォールバック先のモデルをセッションごとに追跡

### 1.2 設定機能
- **カスタムフォールバックリスト**: 優先順位付きのフォールバックモデルリストを設定可能
- **クールダウン期間**: レート制限されたモデルの再試行までの待機時間を設定
- **フォールバックモード**: 3つの動作モード（cycle, stop, retry-last）をサポート
- **有効/無効切り替え**: プラグインのオン/オフを設定可能

### 1.3 通知機能
- **トースト通知**: レート制限検知、フォールバック実行、成功時にユーザーにフィードバック

## 2. 非機能要件（Non-Functional Requirements）

### 2.1 パフォーマンス
- **フォールバック処理時間**: 500ms以内にフォールバック処理を完了
- **メモリ使用量**: セッション状態のメモリリークを防ぐため、30秒以上経過した状態は自動削除
- **重複防止**: 5秒以内の重複フォールバック処理を防止

### 2.2 信頼性
- **エラーハンドリング**: フォールバック処理中のエラーを捕捉し、ユーザーに通知
- **状態復元**: フォールバック失敗時の適切なエラー表示

### 2.3 設定性
- **設定ファイルの優先順位**: プロジェクト固有 → ホームディレクトリ → デフォルト
- **検索パス**: `~/.opencode/`, `~/.config/opencode/`, `<project>/.opencode/`, `<project>/`

### 2.4 セキュリティ
- **設定ファイルの検証**: JSONパースエラー時の安全なフォールバック（デフォルト設定を使用）
- **型安全性**: unknown型を使用し、ランタイムエラーを防止

## 3. 受け入れ基準（Acceptance Criteria）

### 3.1 必須基準
- [x] レート制限エラーを検知し、フォールバックモデルに自動切り替え
- [x] 設定ファイルからフォールバックモデルリストを読み込み
- [x] クールダウン期間中のモデルをスキップ
- [x] 3つのフォールバックモード（cycle, stop, retry-last）を実装
- [x] トースト通知でユーザーにフィードバック
- [x] TypeScriptの型チェックをパス
- [x] 全テストをパス

### 3.2 品質基準
- [x] テストカバレッジ80%以上
- [x] コードレビューによる改善完了
- [x] CIパイプラインの成功
- [x] npmパッケージとして公開可能

## 4. 設計方針（Design Principles）

### 4.1 イベント駆動アーキテクチャ
- OpenCodeのイベントシステムを活用
- 複数のイベントタイプを購読し、包括的なエラー検知

### 4.2 状態管理
- インメモリMapを使用した軽量な状態管理
- セッションごとの独立した状態を保持
- 自動クリーンアップによるメモリ管理

### 4.3 設定の優先順位
- 階層的な設定ロード（プロジェクト > ユーザー > デフォルト）
- 部分設定のマージ（ユーザー設定がない項目はデフォルトを使用）

### 4.4 エラーハンドリング
- 検知されたエラーのみを処理（予期しないエラーは無視）
- フォールバック失敗時のユーザー通知

## 5. アーキテクチャ（Architecture）

### 5.1 コンポーネント構成

```
┌─────────────────────────────────────────────────────────────┐
│                      RateLimitFallback                        │
│                         (Plugin Entry)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Config      │  │ State       │  │ Event Handlers      │  │
│  │ Loader      │  │ Management  │  │                     │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                     │             │
│         ▼                ▼                     ▼             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Fallback Logic                             │ │
│  │  - isRateLimitError()    - findNextAvailableModel()     │ │
│  │  - markModelRateLimited() - handleRateLimitFallback()   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 データフロー

```
┌──────────────┐     ┌──────────────────┐     ┌──────────────┐
│   OpenCode   │────▶│   Event Listener │────▶│  Error Check │
│   Events     │     │                  │     │              │
└──────────────┘     └──────────────────┘     └──────┬───────┘
                                                    │
                    ┌───────────────────────────────┘
                    │
                    ▼
┌──────────────┐     ┌──────────────────┐     ┌──────────────┐
│   Success    │◀────│  Retry with New  │◀────│ Find Next    │
│   Toast      │     │  Model           │     │ Model        │
└──────────────┘     └──────────────────┘     └──────────────┘
```

### 5.3 状態管理

```typescript
// レート制限状態
rateLimitedModels: Map<modelKey, timestamp>

// リトライ状態（メッセージごと）
retryState: Map<stateKey, { attemptedModels: Set<modelKey>, lastAttemptTime: number }>

// セッション現在モデル
currentSessionModel: Map<sessionID, { providerID, modelID }>

// フォールバック進行中（重複防止）
fallbackInProgress: Map<sessionID, timestamp>
```

## 6. トレードオフ（Trade-offs）

### 6.1 採用した設計

| 選択 | 理由 | トレードオフ |
|------|------|-------------|
| **インメモリMap** | シンプルで高速 | プロセス再起動時に状態が失われる |
| **5秒重複防止** | UIの過剰反応を防止 | 誤検知時の迅速な再試行が遅れる |
| **30秒状態有効期限** | メモリリーク防止 | 長時間セッションで状態が失われる可能性 |
| **設定ファイル（JSON）** | シンプルで編集しやすい | バリデーションが限定的 |

### 6.2 将来の改善案

1. **永続化ストレージ**: Redisやファイルベースの状態永続化
2. **詳細なロギング**: デバッグ用の構造化ログ
3. **メトリクス収集**: フォールバック頻度の統計
4. **動的モデルリスト**: API経由でのモデルリスト更新
5. **バックオフ戦略**: 指数関数的バックオフのサポート

## 7. ファイル構成

```
.
├── index.ts                    # メインプラグインコード
├── package.json                # npmパッケージ設定
├── tsconfig.json               # TypeScript設定
├── vitest.config.ts            # テスト設定
├── src/
│   └── __tests__/
│       └── index.test.ts       # ユニットテスト
├── .github/workflows/
│   ├── ci.yml                  # CI設定
│   └── npm-publish.yml         # 公開ワークフロー
└── tmp/
    └── ARCH.md                 # この設計ドキュメント
```

## 8. 更新履歴

- **2025-02-09**: 初版作成（リファクタリング完了後）
